<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Messaggi e risposte temporanei</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Inter", "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #fdfcfb, #e2d1c3);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px;
      color: #333;
    }
    .container {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.1);
      padding: 32px;
      width: 100%;
      max-width: 800px;
    }
    h1 { font-size: 1.8rem; margin-bottom: 16px; color: #4b5563; text-align: center; }
    textarea, input[type="text"] {
      width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 14px;
      font-size: 16px; background: #fafafa; margin-bottom: 10px;
    }
    button {
      padding: 12px 18px; border: none; border-radius: 14px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: #fff; font-weight: 600; font-size: 16px; cursor: pointer;
    }
    .messages { margin-top: 24px; }
    .message {
      background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 16px;
      padding: 14px; margin-bottom: 14px;
    }
    .message-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
    }
    .countdown { font-size: 14px; color: #6b7280; }
    .published { font-size: 12px; color: #6b7280; }
    .replies { margin-top: 8px; padding-left: 12px; border-left: 3px solid #e5e7eb; }
    .reply {
      background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px;
      padding: 10px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .reply-footer { display: flex; gap: 8px; align-items: center; }
    .reply-form { display: flex; gap: 8px; margin-top: 8px; }
    .fadeout { opacity: 0; height: 0; margin: 0; padding: 0; transition: all 0.6s ease; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí¨ Messaggi temporanei con risposte</h1>

    <textarea id="box" placeholder="Scrivi un messaggio..."></textarea>
    <button id="publish">Pubblica</button>

    <div class="messages" id="messages"></div>
  </div>

 <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyBEzIJI46QmYNVyIhmVj-A8ib-ZXbfZvNc",
  authDomain: "dillo-74511.firebaseapp.com",
  databaseURL: "https://dillo-74511-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dillo-74511",
  storageBucket: "dillo-74511.appspot.com",
  messagingSenderId: "15567007246",
  appId: "1:15567007246:web:0e24ef0899d0187317d65f"
};


    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const box = document.getElementById("box");
    const publishBtn = document.getElementById("publish");
    const messagesDiv = document.getElementById("messages");

    // Utilit√†: formatta data/ora in italiano
    function formatNow() {
      const now = new Date();
      return now.toLocaleString("it-IT", {
        day: "2-digit", month: "2-digit", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    }

    // Pubblica messaggio (solo text + publishedAt nel DB)
    publishBtn.addEventListener("click", () => {
      const text = box.value.trim();
      if (!text) return;
      push(ref(db, "messages"), {
        text,
        publishedAt: formatNow()
      });
      box.value = "";
    });

    // Render con countdown di 60s lato client (non cancella dal DB)
    onValue(ref(db, "messages"), snapshot => {
      messagesDiv.innerHTML = "";
      const data = snapshot.val() || {};

      // Per avere un ordine dal pi√π recente al pi√π vecchio
      const entries = Object.entries(data).sort((a, b) => {
        const pa = a[1].publishedAt || "";
        const pb = b[1].publishedAt || "";
        return pb.localeCompare(pa);
      });

      for (const [id, msgData] of entries) {
        const messageEl = document.createElement("div");
        messageEl.className = "message";

        const header = document.createElement("div");
        header.className = "message-header";

        const textEl = document.createElement("div");
        textEl.textContent = msgData.text;

        const countdownEl = document.createElement("span");
        countdownEl.className = "countdown";

        header.appendChild(textEl);
        header.appendChild(countdownEl);

        const publishedEl = document.createElement("div");
        publishedEl.className = "published";
        publishedEl.textContent = `Pubblicato: ${msgData.publishedAt}`;

        messageEl.appendChild(header);
        messageEl.appendChild(publishedEl);

        // Sezione risposte
        const repliesWrap = document.createElement("div");
        repliesWrap.className = "replies";

        // Mostra risposte esistenti (se presenti)
        const replies = msgData.replies || {};
        const repliesEntries = Object.entries(replies);
        for (const [rid, replyData] of repliesEntries) {
          const replyEl = createReplyEl(replyData);
          repliesWrap.appendChild(replyEl);
        }

        // Form di risposta
        const replyForm = document.createElement("div");
        replyForm.className = "reply-form";

        const replyInput = document.createElement("input");
        replyInput.type = "text";
        replyInput.placeholder = "Scrivi una risposta...";

        const replyBtn = document.createElement("button");
        replyBtn.textContent = "Rispondi";
        replyBtn.addEventListener("click", () => {
          const rtext = replyInput.value.trim();
          if (!rtext) return;
          push(ref(db, `messages/${id}/replies`), {
            text: rtext,
            publishedAt: formatNow()
          });
          replyInput.value = "";
        });

        replyForm.appendChild(replyInput);
        replyForm.appendChild(replyBtn);

        repliesWrap.appendChild(replyForm);
        messageEl.appendChild(repliesWrap);
        messagesDiv.appendChild(messageEl);

        // Countdown 60s per il messaggio (sparisce dall'interfaccia)
        startCountdown(countdownEl, messageEl, 60);
      }
    });

    // Crea elemento risposta con countdown 60s
    function createReplyEl(replyData) {
      const wrap = document.createElement("div");
      wrap.className = "reply";

      const content = document.createElement("div");
      content.innerHTML = `<strong>${replyData.text}</strong><br><small>${replyData.publishedAt}</small>`;

      const footer = document.createElement("div");
      footer.className = "reply-footer";

      const cd = document.createElement("span");
      cd.className = "countdown";

      footer.appendChild(cd);

      wrap.appendChild(content);
      wrap.appendChild(footer);

      startCountdown(cd, wrap, 60); // nascondi risposta dopo 60s (non cancella dal DB)
      return wrap;
    }

    // Avvia countdown e nascondi elemento quando arriva a 0
    function startCountdown(labelEl, containerEl, seconds) {
      let remaining = seconds;
      labelEl.textContent = `‚è±Ô∏è ${remaining}s`;
      const intervalId = setInterval(() => {
        remaining--;
        labelEl.textContent = `‚è±Ô∏è ${remaining}s`;
        if (remaining <= 0) {
          clearInterval(intervalId);
          containerEl.classList.add("fadeout");
          setTimeout(() => containerEl.remove(), 600);
        }
      }, 1000);
    }
  </script>
</body>
</html>



















